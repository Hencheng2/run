<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multi-Language IDE with Pyodide</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  <style>
    body { background-color: #1e1e1e; color: #e0e0e0; font-family: Arial, sans-serif; }
    #editor { height: calc(100vh - 120px); border: 1px solid #333; }
    #file-explorer { width: 220px; border-right: 1px solid #333; overflow-y: auto; }
    .file-item { padding: 6px; cursor: pointer; display: flex; justify-content: space-between; }
    .file-item:hover { background: #2a2a2a; }
    .active-file { background: #333; font-weight: bold; }
    .delete-btn { opacity: 0; margin-left: 5px; }
    .file-item:hover .delete-btn { opacity: 1; }
    #output { background: #111; border-top: 1px solid #333; height: 200px; overflow-y: auto; white-space: pre-wrap; padding: 5px; }
    #status-bar { background: #111; border-top: 1px solid #333; padding: 5px 10px; font-size: 14px; }
    #tabs button.active { background: #333; }
    iframe { width: 100%; height: 100%; border: none; background: white; }
  </style>
</head>
<body class="flex flex-col h-screen">

  <!-- Toolbar -->
  <header class="flex items-center gap-2 p-2 bg-gray-900 text-white">
    <select id="language" class="bg-gray-800 text-white p-1 rounded">
      <option value="python">Python</option>
      <option value="javascript">JavaScript</option>
      <option value="html">HTML</option>
      <option value="css">CSS</option>
      <option value="typescript">TypeScript</option>
      <option value="cpp">C++</option>
      <option value="java">Java</option>
      <option value="go">Go</option>
      <option value="rust">Rust</option>
      <option value="swift">Swift</option>
      <option value="php">PHP</option>
      <option value="ruby">Ruby</option>
      <option value="sql">SQL</option>
    </select>
    <input id="project-name" type="text" class="bg-gray-800 p-1 rounded text-white w-40" placeholder="Project Name" value="MyProject"/>
    <button onclick="runCode()" class="bg-green-600 px-3 py-1 rounded">Run</button>
    <button onclick="refreshPage()" class="bg-blue-600 px-3 py-1 rounded">Refresh</button>
    <button onclick="saveProject()" class="bg-yellow-600 px-3 py-1 rounded">Save</button>
    <button onclick="downloadProject()" class="bg-purple-600 px-3 py-1 rounded">Download</button>
    <input type="file" id="upload-file" class="hidden" onchange="uploadFile(event)"/>
    <button onclick="document.getElementById('upload-file').click()" class="bg-gray-700 px-3 py-1 rounded">Upload File</button>
    <button onclick="newFile()" class="bg-gray-700 px-3 py-1 rounded">New File</button>
    <button onclick="newProject()" class="bg-red-600 px-3 py-1 rounded">New Project</button>
  </header>

  <!-- Main -->
  <div class="flex flex-1 overflow-hidden">
    <!-- File Explorer -->
    <div id="file-explorer" class="bg-gray-900 text-white p-2">
      <h3 class="font-bold mb-2">Files</h3>
      <div id="file-tree"></div>
      <h3 class="font-bold mt-4 mb-2">Dependencies</h3>
      <div id="dependency-files"></div>
    </div>

    <!-- Editor -->
    <div id="editor" class="flex-1"></div>

    <!-- Output -->
    <div class="flex flex-col w-1/3 bg-gray-900 text-white">
      <div id="tabs" class="flex">
        <button id="console-tab" onclick="switchTab('console')" class="flex-1 p-2 active">Console</button>
        <button id="html-tab" onclick="switchTab('html')" class="flex-1 p-2">HTML Output</button>
      </div>
      <div id="console-output" class="flex-1 overflow-y-auto bg-black text-green-400 p-2 font-mono"></div>
      <div id="html-output" class="hidden flex-1 overflow-hidden">
        <iframe id="html-frame"></iframe>
      </div>
    </div>
  </div>

  <!-- Status -->
  <footer id="status-bar">Status: Idle</footer>

  <script>
    let editor, pyodide;
    let state = {
      currentLanguage: 'python',
      currentFile: 'main.py',
      projectName: 'MyProject',
      files: []
    };

    const languageMap = {
      python: { defaultFile: "main.py", template: "print('Hello, Python!')", deps: ["requirements.txt"] },
      javascript: { defaultFile: "main.js", template: "console.log('Hello, JS!')", deps: ["package.json"] },
      html: { defaultFile: "index.html", template: "<!DOCTYPE html><html><body><h1>Hello HTML</h1></body></html>", deps: ["style.css", "script.js"] },
      css: { defaultFile: "style.css", template: "body { background: #222; color: white; }", deps: [] },
      typescript: { defaultFile: "main.ts", template: "let msg: string = 'Hello TS'; console.log(msg);", deps: [] },
      cpp: { defaultFile: "main.cpp", template: "#include <iostream>\nint main(){std::cout<<\"Hello C++\";}", deps: [] },
      java: { defaultFile: "Main.java", template: "class Main{public static void main(String[] args){System.out.println(\"Hello Java\");}}", deps: [] },
      go: { defaultFile: "main.go", template: "package main\nimport \"fmt\"\nfunc main(){fmt.Println(\"Hello Go\")}", deps: [] },
      rust: { defaultFile: "main.rs", template: "fn main(){println!(\"Hello Rust\");}", deps: [] },
      swift: { defaultFile: "main.swift", template: "print(\"Hello Swift\")", deps: [] },
      php: { defaultFile: "index.php", template: "<?php echo 'Hello PHP'; ?>", deps: [] },
      ruby: { defaultFile: "main.rb", template: "puts 'Hello Ruby'", deps: [] },
      sql: { defaultFile: "main.sql", template: "SELECT 'Hello SQL';", deps: [] }
    };

    async function init() {
      loadState();
      renderFileTree();
      renderDependencyFiles();
      loadEditor();
      pyodide = await loadPyodide();
      setStatus("Pyodide loaded");
    }

    function loadEditor() {
      require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }});
      require(["vs/editor/editor.main"], function () {
        editor = monaco.editor.create(document.getElementById('editor'), {
          value: getFile(state.currentFile).content,
          language: getLanguageFromFile(state.currentFile),
          theme: "vs-dark",
          automaticLayout: true
        });
        editor.onDidChangeModelContent(() => {
          getFile(state.currentFile).content = editor.getValue();
          saveState();
        });
      });
    }

    function getLanguageFromFile(file) {
      const ext = file.split('.').pop();
      if (ext === 'py') return 'python';
      if (ext === 'js') return 'javascript';
      if (ext === 'html') return 'html';
      if (ext === 'css') return 'css';
      if (ext === 'ts') return 'typescript';
      if (ext === 'cpp') return 'cpp';
      if (ext === 'java') return 'java';
      if (ext === 'go') return 'go';
      if (ext === 'rs') return 'rust';
      if (ext === 'swift') return 'swift';
      if (ext === 'php') return 'php';
      if (ext === 'rb') return 'ruby';
      if (ext === 'sql') return 'sql';
      return 'plaintext';
    }

    function getFile(name) {
      return state.files.find(f => f.name === name);
    }

    function renderFileTree() {
      const tree = document.getElementById('file-tree');
      tree.innerHTML = "";
      state.files.forEach(f => {
        const div = document.createElement("div");
        div.className = "file-item" + (f.name === state.currentFile ? " active-file" : "");
        div.innerHTML = f.name + `<span class="delete-btn text-red-500" onclick="deleteFile('${f.name}', event)">âœ–</span>`;
        div.onclick = () => switchFile(f.name);
        tree.appendChild(div);
      });
    }

    function renderDependencyFiles() {
      const depDiv = document.getElementById('dependency-files');
      depDiv.innerHTML = "";
      (languageMap[state.currentLanguage].deps || []).forEach(d => {
        if (!state.files.find(f => f.name === d)) {
          state.files.push({ name: d, content: "" });
        }
        const div = document.createElement("div");
        div.className = "file-item";
        div.textContent = d;
        div.onclick = () => switchFile(d);
        depDiv.appendChild(div);
      });
    }

    function switchFile(name) {
      saveCurrentFile();
      state.currentFile = name;
      const file = getFile(name);
      const lang = getLanguageFromFile(name);
      monaco.editor.setModelLanguage(editor.getModel(), lang);
      editor.setValue(file.content);
      renderFileTree();
      saveState();
    }

    function saveCurrentFile() {
      if (editor && state.currentFile) {
        getFile(state.currentFile).content = editor.getValue();
      }
    }

    function newFile() {
      const name = prompt("File name:");
      if (name && !getFile(name)) {
        state.files.push({ name, content: "" });
        switchFile(name);
        renderFileTree();
        saveState();
      }
    }

    function deleteFile(name, e) {
      e.stopPropagation();
      state.files = state.files.filter(f => f.name !== name);
      if (state.currentFile === name && state.files.length) {
        switchFile(state.files[0].name);
      }
      renderFileTree();
      saveState();
    }

    function uploadFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        state.files.push({ name: file.name, content: e.target.result });
        renderFileTree();
        saveState();
      };
      reader.readAsText(file);
    }

    function newProject() {
      if (!confirm("Start a new project?")) return;
      state = { currentLanguage: 'python', currentFile: 'main.py', projectName: 'MyProject', files: [] };
      state.files.push({ name: 'main.py', content: "print('Hello, Python!')" });
      switchFile('main.py');
      renderFileTree();
      renderDependencyFiles();
      saveState();
    }

    function refreshPage() { location.reload(); }

    function saveProject() {
      saveCurrentFile();
      localStorage.setItem("projectState", JSON.stringify(state));
      setStatus("Project saved");
    }

    function loadState() {
      const saved = localStorage.getItem("projectState");
      if (saved) state = JSON.parse(saved);
      if (!state.files.length) {
        state.files.push({ name: 'main.py', content: "print('Hello, Python!')" });
      }
    }

    function saveState() {
      localStorage.setItem("projectState", JSON.stringify(state));
    }

    function downloadProject() {
      saveCurrentFile();
      const blob = new Blob([JSON.stringify(state)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = state.projectName + ".coderunner.json";
      a.click();
    }

    function setStatus(msg) {
      document.getElementById('status-bar').textContent = "Status: " + msg;
    }

    function clearConsole() {
      document.getElementById('console-output').textContent = "";
    }

    function logToConsole(msg) {
      document.getElementById('console-output').textContent += msg + "\n";
    }

    function switchTab(tab) {
      document.getElementById('console-tab').classList.remove('active');
      document.getElementById('html-tab').classList.remove('active');
      document.getElementById('console-output').classList.add('hidden');
      document.getElementById('html-output').classList.add('hidden');
      if (tab === 'console') {
        document.getElementById('console-tab').classList.add('active');
        document.getElementById('console-output').classList.remove('hidden');
      } else {
        document.getElementById('html-tab').classList.add('active');
        document.getElementById('html-output').classList.remove('hidden');
      }
    }

    async function runCode() {
      saveCurrentFile();
      clearConsole();
      const lang = state.currentLanguage;
      setStatus("Running " + lang);
      if (lang === 'python') {
        await runPython();
      } else if (['html', 'css', 'javascript', 'typescript'].includes(lang)) {
        runWeb();
      } else {
        logToConsole("Execution for " + lang + " not implemented yet.");
      }
      setStatus("Idle");
    }

    async function runPython() {
      try {
        const pyFiles = state.files.filter(f => f.name.endsWith('.py'));
        let code = pyFiles.map(f => f.content).join('\n');
        const reqFile = getFile('requirements.txt');
        if (reqFile && reqFile.content.trim()) {
          await pyodide.loadPackage('micropip');
          const micropip = pyodide.pyimport('micropip');
          const deps = reqFile.content.split('\n').map(l => l.trim()).filter(l => l);
          for (let d of deps) { await micropip.install(d); }
        }
        let result = await pyodide.runPythonAsync(code);
        if (result !== undefined) logToConsole(result.toString());
      } catch (e) {
        logToConsole("Error: " + e);
      }
    }

    function runWeb() {
      const html = state.files.filter(f => f.name.endsWith('.html')).map(f => f.content).join('\n') || "<!DOCTYPE html><html><body></body></html>";
      const css = state.files.filter(f => f.name.endsWith('.css')).map(f => `<style>${f.content}</style>`).join('\n');
      let js = state.files.filter(f => f.name.endsWith('.js') || f.name.endsWith('.ts')).map(f => f.content).join('\n');
      // crude TS strip
      js = js.replace(/:\s*\w+/g, "");
      const iframe = document.getElementById('html-frame');
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      doc.open();
      doc.write(html.replace('</body>', css + '<script>' + js + '<\/script></body>'));
      doc.close();
      switchTab('html');
    }

    window.onload = init;
  </script>
</body>
</html>
